# JWTä»¤ç‰Œç®¡ç†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

> ğŸ“‹ **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯å®ç°æ–‡æ¡£  
> ğŸ¯ **ç›®æ ‡**: JWTä»¤ç‰Œè‡ªåŠ¨åˆ·æ–°æœºåˆ¶æŠ€æœ¯å®ç°  
> ğŸ“… **æ›´æ–°æ—¶é—´**: 2025å¹´1æœˆ  
> âœ… **çŠ¶æ€**: å·²å®Œæˆå®ç°

---

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†å®Œæ•´çš„JWTä»¤ç‰Œè‡ªåŠ¨åˆ·æ–°æœºåˆ¶ï¼Œæä¾›äº†æ™ºèƒ½çš„ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œç¡®ä¿ç”¨æˆ·æ— æ„ŸçŸ¥çš„ç™»å½•çŠ¶æ€ç»´æŠ¤ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- ğŸ”„ **è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°**: ä»¤ç‰Œè¿‡æœŸå‰5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
- ğŸ¯ **æ»‘åŠ¨è¿‡æœŸæœºåˆ¶**: APIè°ƒç”¨æˆåŠŸæ—¶åœ¨æœ€å30åˆ†é’Ÿå†…é‡ç½®ä»¤ç‰Œ
- ğŸ›¡ï¸ **æ™ºèƒ½çŠ¶æ€ç®¡ç†**: å‰ç«¯è‡ªåŠ¨ç»´æŠ¤ä»¤ç‰Œæœ‰æ•ˆæ€§
- ğŸ”§ **å¼€å‘è°ƒè¯•å·¥å…·**: å¯è§†åŒ–ä»¤ç‰ŒçŠ¶æ€ç›‘æ§

---

## ğŸ”§ æŠ€æœ¯æ¶æ„

### 1. æ ¸å¿ƒç»„ä»¶

#### TokenManager ä»¤ç‰Œç®¡ç†å™¨
```typescript
// ä¸»è¦åŠŸèƒ½
- saveToken()           // ä¿å­˜ä»¤ç‰Œå¹¶å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
- refreshToken()        // åˆ·æ–°ä»¤ç‰Œ
- clearToken()          // æ¸…é™¤ä»¤ç‰Œ
- ensureValidToken()    // ç¡®ä¿ä»¤ç‰Œæœ‰æ•ˆ
- resetTokenTimeOnApiCall() // æ»‘åŠ¨è¿‡æœŸæœºåˆ¶
- getTokenStatus()      // è·å–ä»¤ç‰ŒçŠ¶æ€ï¼ˆè°ƒè¯•ç”¨ï¼‰
```

#### è¯·æ±‚æ‹¦æˆªå™¨
- æ¯æ¬¡APIè°ƒç”¨å‰æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§
- è‡ªåŠ¨æ·»åŠ Authorizationå¤´
- å¤„ç†ä¸åŒç±»å‹çš„è¯·æ±‚æ•°æ®

#### å“åº”æ‹¦æˆªå™¨
- APIè°ƒç”¨æˆåŠŸæ—¶è§¦å‘æ»‘åŠ¨è¿‡æœŸæœºåˆ¶
- 401é”™è¯¯æ—¶è‡ªåŠ¨æ¸…é™¤ä»¤ç‰Œ
- ç»Ÿä¸€é”™è¯¯å¤„ç†

### 2. æ—¶é—´è®¡ç®—ä¿®å¤

#### é—®é¢˜æ ¹æº
- **åç«¯é…ç½®**: 604,800,000æ¯«ç§’ (7å¤©)
- **åç«¯è¿”å›**: 604,800ç§’ (7å¤©)
- **å‰ç«¯é”™è¯¯ç†è§£**: 604,800æ¯«ç§’ â‰ˆ 10åˆ†é’Ÿ
- **ä¿®å¤æ–¹æ¡ˆ**: `expiresIn * 1000` è½¬æ¢ä¸ºæ¯«ç§’

#### ä¿®å¤åæ•ˆæœ
```typescript
// æ­£ç¡®çš„æ—¶é—´è®¡ç®—
const expirationTime = tokenInfo.issuedAt + (tokenInfo.expiresIn * 1000);
```

### 3. æ»‘åŠ¨è¿‡æœŸæœºåˆ¶

#### å®ç°ç­–ç•¥
- **è§¦å‘æ—¶æœº**: APIè°ƒç”¨æˆåŠŸååœ¨å“åº”æ‹¦æˆªå™¨ä¸­æ‰§è¡Œ
- **æ™ºèƒ½åˆ¤æ–­**: åªåœ¨tokenå‰©ä½™æ—¶é—´â‰¤30åˆ†é’Ÿæ—¶åˆ·æ–°
- **é¿å…è¿‡åº¦åˆ·æ–°**: å‰©ä½™æ—¶é—´>30åˆ†é’Ÿä¸åˆ·æ–°

#### æ ¸å¿ƒä»£ç 
```typescript
static async resetTokenTimeOnApiCall(): Promise<boolean> {
  const tokenInfo = this.getTokenInfo();
  if (!tokenInfo) return false;

  const now = Date.now();
  const expirationTime = tokenInfo.issuedAt + (tokenInfo.expiresIn * 1000);
  const remainingTime = expirationTime - now;
  
  // æ»‘åŠ¨è¿‡æœŸé˜ˆå€¼ï¼š30åˆ†é’Ÿ
  const slidingThreshold = 30 * 60 * 1000;

  // åªæœ‰åœ¨å‰©ä½™æ—¶é—´å°‘äº30åˆ†é’Ÿæ—¶æ‰åˆ·æ–°
  if (remainingTime > slidingThreshold) {
    return true;
  }

  console.log(`ğŸ”„ APIè°ƒç”¨æˆåŠŸï¼Œä»¤ç‰Œå‰©ä½™æ—¶é—´å°‘äº30åˆ†é’Ÿï¼Œæ‰§è¡Œæ»‘åŠ¨åˆ·æ–°...`);
  return await this.refreshToken();
}
```

---

## ğŸš€ æ¥å£æ ‡å‡†åŒ–

### åç«¯æ¥å£ä¿®æ”¹
```java
/**
 * åˆ·æ–°JWTä»¤ç‰Œ
 * @param authorization Authorizationè¯·æ±‚å¤´ï¼ˆåŒ…å«JWT tokenï¼‰
 * @return æ–°çš„JWTä»¤ç‰Œ
 */
@PostMapping("/refresh-token")
public Result<LoginVO> refreshToken(@RequestHeader("Authorization") String authorization) {
    if (authorization == null || !authorization.startsWith("Bearer ")) {
        return ResultUtils.returnFail(401, "ç¼ºå°‘æœ‰æ•ˆçš„Authorizationå¤´");
    }
    
    String token = authorization.substring(7); // ç§»é™¤ "Bearer " å‰ç¼€
    LoginVO loginVO = userService.refreshToken(token);
    return ResultUtils.returnSuccess(loginVO);
}
```

### å‰ç«¯æ¥å£è°ƒç”¨
```typescript
export async function refreshTokenApi(params: RefreshTokenRequest): Promise<LoginVO> {
  try {
    // åˆ›å»ºä¸´æ—¶axioså®ä¾‹ï¼Œç»•è¿‡æ‹¦æˆªå™¨é¿å…å¾ªç¯è°ƒç”¨
    const tempAxios = request.create({
      baseURL: 'http://localhost:8080',
      timeout: 15000,
      headers: {
        'Content-Type': 'application/json;charset=utf-8',
        'Authorization': `Bearer ${params.token}`
      }
    });

    const response = await tempAxios.post('/user/refresh-token', {});
    const result: ApiResponse<LoginVO> = response.data;
    
    if (result.code === 0) {
      return result.data;
    } else {
      throw new Error(result.message || 'åˆ·æ–°ä»¤ç‰Œå¤±è´¥');
    }
  } catch (error: any) {
    console.error('åˆ·æ–°ä»¤ç‰Œå¤±è´¥:', error);
    throw new Error(error.response?.data?.message || error.message || 'åˆ·æ–°ä»¤ç‰Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}
```

---

## âš™ï¸ é…ç½®å‚æ•°

### åç«¯é…ç½®
```properties
# application.properties
jwt.secret=myCustomSecretKey123456789012345678901234567890abcdefghijklmnopqrstuvwxyz
jwt.expiration=604800000  # 7å¤©è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
```

### å‰ç«¯é…ç½®
```typescript
// TokenManageré…ç½®
private static readonly REFRESH_THRESHOLD = 5 * 60 * 1000;     // æå‰5åˆ†é’Ÿåˆ·æ–°
private static readonly SLIDING_THRESHOLD = 30 * 60 * 1000;    // æ»‘åŠ¨è¿‡æœŸé˜ˆå€¼30åˆ†é’Ÿ
private static refreshTimer: NodeJS.Timeout | null = null;      // å®šæ—¶å™¨
```

---

## ğŸ”„ å®Œæ•´è°ƒç”¨é“¾è·¯

1. **ç”¨æˆ·è°ƒç”¨API** â†’ è¯·æ±‚æ‹¦æˆªå™¨æ£€æŸ¥tokenæœ‰æ•ˆæ€§ â†’ æ·»åŠ tokenåˆ°è¯·æ±‚å¤´ â†’ å‘é€HTTPè¯·æ±‚
2. **åç«¯å¤„ç†è¯·æ±‚** â†’ å“åº”æ‹¦æˆªå™¨æ¥æ”¶å“åº” â†’ åœ¨tokenæœ€å30åˆ†é’Ÿå†…æ—¶åˆ·æ–°token â†’ è¿”å›å“åº”æ•°æ®
3. **æ»‘åŠ¨è¿‡æœŸåˆ¤æ–­**: å‰©ä½™æ—¶é—´>30åˆ†é’Ÿä¸åˆ·æ–°ï¼Œâ‰¤30åˆ†é’Ÿä¸”APIè°ƒç”¨æˆåŠŸæ—¶æ‰§è¡Œåˆ·æ–°
4. **åˆ·æ–°æ—¶è°ƒç”¨åç«¯refresh-token API** â†’ ä¿å­˜æ–°token â†’ è¿”å›åŸå§‹å“åº”

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### æ™ºèƒ½åˆ·æ–°ç­–ç•¥
- **æ–°ç™»å½•ç”¨æˆ·**: 6.5å°æ—¶å†…ä¸åˆ·æ–°token
- **æ´»è·ƒç”¨æˆ·**: åªåœ¨æœ€å30åˆ†é’Ÿåˆ·æ–°
- **æœåŠ¡å™¨è´Ÿè½½**: å¤§å¹…å‡å°‘åˆ·æ–°é¢‘ç‡
- **ç”¨æˆ·ä½“éªŒ**: å®Œå…¨æ— æ„ŸçŸ¥çš„tokenç®¡ç†

### å¯¹æ¯”åˆ†æ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **å“åº”æ‹¦æˆªå™¨** | â€¢ åªæœ‰æˆåŠŸçš„APIè°ƒç”¨æ‰å»¶é•¿token<br>â€¢ çœŸæ­£çš„ç”¨æˆ·æ´»è·ƒæ£€æµ‹<br>â€¢ é¿å…å¤±è´¥è¯·æ±‚çš„æ— æ•ˆåˆ·æ–°<br>â€¢ ç¬¦åˆæ»‘åŠ¨è¿‡æœŸæ¦‚å¿µ | â€¢ å¯èƒ½çš„ç«æ€æ¡ä»¶<br>â€¢ é€»è¾‘ç¨å¾®åˆ†æ•£ | â­â­â­â­â­ |
| **è¯·æ±‚æ‹¦æˆªå™¨** | â€¢ é¢„é˜²æ€§åˆ·æ–°<br>â€¢ é€»è¾‘é›†ä¸­<br>â€¢ é¿å…æ— æ•ˆè¯·æ±‚ | â€¢ å¯èƒ½è¿‡åº¦åˆ·æ–°<br>â€¢ å¤±è´¥è¯·æ±‚ä¹Ÿä¼šåˆ·æ–°<br>â€¢ å¢åŠ è¯·æ±‚å»¶è¿Ÿ | â­â­â­ |

---

## ğŸ” è°ƒè¯•ä¸ç›‘æ§

### å¼€å‘ç¯å¢ƒè°ƒè¯•å·¥å…·
```typescript
// TokenStatusDebugç»„ä»¶
- å®æ—¶æ˜¾ç¤ºä»¤ç‰Œæœ‰æ•ˆæ€§
- æ˜¾ç¤ºè¿‡æœŸçŠ¶æ€å’Œå‰©ä½™æ—¶é—´
- æ”¯æŒæ‰‹åŠ¨åˆ·æ–°å’Œæ¸…é™¤æ“ä½œ
- ä»…åœ¨å¼€å‘ç¯å¢ƒæ˜¾ç¤º
```

### æ§åˆ¶å°æ—¥å¿—
```
ğŸ’¾ Tokenå·²ä¿å­˜ï¼Œè¿‡æœŸæ—¶é—´: 2025-01-28T10:00:00.000Z
âš¡ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨å·²å¯åŠ¨
ğŸš€ ä»¤ç‰Œç®¡ç†å™¨å·²åˆå§‹åŒ–
â° æ£€æµ‹åˆ°ä»¤ç‰Œå³å°†è¿‡æœŸï¼Œå°è¯•è‡ªåŠ¨åˆ·æ–°...
ğŸ”„ æ­£åœ¨åˆ·æ–°ä»¤ç‰Œ...
âœ… ä»¤ç‰Œåˆ·æ–°æˆåŠŸ
```

---

## ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

### Authorization vs Cookieå¯¹æ¯”

| ç‰¹æ€§ | JWT Authorization Header | Cookie |
|------|-------------------------|--------|
| **å­˜å‚¨ä½ç½®** | localStorage + HTTP Header | æµè§ˆå™¨Cookieå­˜å‚¨ |
| **ä¼ è¾“æ–¹å¼** | `Authorization: Bearer <token>` | è‡ªåŠ¨å‘é€Cookieå¤´ |
| **å®‰å…¨æ€§** | éœ€è¦æ‰‹åŠ¨é˜²æŠ¤XSS | æ”¯æŒHttpOnlyé˜²æŠ¤ |
| **è·¨åŸŸæ”¯æŒ** | å®Œå…¨æ”¯æŒ | éœ€è¦CORSé…ç½® |
| **ç§»åŠ¨ç«¯æ”¯æŒ** | å®Œç¾æ”¯æŒ | éƒ¨åˆ†é™åˆ¶ |
| **æœåŠ¡ç«¯è§£æ** | éœ€è¦æ‰‹åŠ¨è§£æJWT | è‡ªåŠ¨è§£æCookie |
| **æœ‰æ•ˆæœŸæ§åˆ¶** | ä»¤ç‰Œå†…ç½®è¿‡æœŸæ—¶é—´ | æœåŠ¡ç«¯Sessionæ§åˆ¶ |

### å®‰å…¨æœ€ä½³å®è·µ
- ä½¿ç”¨æ ‡å‡†çš„Authorizationå¤´ä¼ è¾“token
- éµå¾ªOAuth 2.0æ ‡å‡†çš„Bearer tokenæ ¼å¼
- åç«¯ä¸¥æ ¼éªŒè¯tokençš„æœ‰æ•ˆæ€§å’Œæ ¼å¼
- å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç è¿”å›

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### 1. ç™»å½•æ—¶è‡ªåŠ¨è®¾ç½®
```typescript
// åœ¨ç™»å½•æˆåŠŸå
TokenManager.saveToken({
  accessToken: loginResult.accessToken,
  tokenType: loginResult.tokenType,
  expiresIn: loginResult.expiresIn  // 7å¤©è¿‡æœŸæ—¶é—´
});
```

### 2. APIè°ƒç”¨æ—¶è‡ªåŠ¨åˆ·æ–°
```typescript
// æ¯æ¬¡è°ƒç”¨APIå‰ä¼šè‡ªåŠ¨æ‰§è¡Œ
const response = await get('/api/user/profile');
// å¦‚æœä»¤ç‰Œå³å°†è¿‡æœŸï¼Œä¼šå…ˆåˆ·æ–°å†å‘é€è¯·æ±‚
```

### 3. æ‰‹åŠ¨æŸ¥çœ‹çŠ¶æ€ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œé¡µé¢å³ä¸‹è§’ä¼šæ˜¾ç¤º"æ˜¾ç¤ºTokençŠ¶æ€"æŒ‰é’®ï¼Œå¯ä»¥å®æ—¶æŸ¥çœ‹ä»¤ç‰ŒçŠ¶æ€ã€‚

---

## ğŸ‰ æ€»ç»“

### è§£å†³çš„æ ¸å¿ƒé—®é¢˜
1. âœ… **JWTä»¤ç‰Œå­˜å‚¨æ—¶é—´ç®¡ç†**: è‡ªåŠ¨ç»´æŠ¤7å¤©çš„ç™»å½•æœ‰æ•ˆæœŸ
2. âœ… **APIè°ƒç”¨æ—¶åˆ·æ–°ä»¤ç‰ŒçŠ¶æ€**: æ¯æ¬¡APIè°ƒç”¨å‰ç¡®ä¿ä»¤ç‰Œæœ‰æ•ˆ
3. âœ… **Authorizationä¸Cookieçš„åŒºåˆ«**: é‡‡ç”¨æ›´ç°ä»£ã€æ›´å®‰å…¨çš„Authorization Headeræ–¹å¼

### æŠ€æœ¯ä¼˜åŠ¿
- **æ™ºèƒ½åˆ·æ–°**: åªåœ¨å¿…è¦æ—¶åˆ·æ–°ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
- **æ»‘åŠ¨è¿‡æœŸ**: æ´»è·ƒç”¨æˆ·æ°¸ä¸è¿‡æœŸ
- **æ ‡å‡†åŒ–æ¥å£**: ä½¿ç”¨Authorizationå¤´ï¼Œç¬¦åˆOAuth 2.0è§„èŒƒ
- **å®Œå–„è°ƒè¯•**: å¼€å‘ç¯å¢ƒä¸‹å¯è§†åŒ–ä»¤ç‰ŒçŠ¶æ€
- **ç”¨æˆ·ä½“éªŒ**: æ— æ„ŸçŸ¥çš„è‡ªåŠ¨ç»­æœŸæœºåˆ¶

è¿™å¥—JWTä»¤ç‰Œç®¡ç†ç³»ç»Ÿæ¯”ä¼ ç»Ÿçš„Cookieæ–¹å¼æ›´çµæ´»ã€æ›´å®‰å…¨ï¼Œç‰¹åˆ«é€‚åˆå•é¡µåº”ç”¨å’Œç§»åŠ¨ç«¯ä½¿ç”¨ã€‚

---

> ğŸ’¡ **æç¤º**: æœ¬æ–‡æ¡£é‡‡ç”¨Notionæ ¼å¼ç¼–å†™ï¼Œå¯ç›´æ¥å¤åˆ¶åˆ°Notionä¸­ä½¿ç”¨ã€‚åŒ…å«å®Œæ•´çš„æŠ€æœ¯å®ç°ç»†èŠ‚å’Œä½¿ç”¨è¯´æ˜ã€‚ 